.macos_saas_runners:
  tags:
    - saas-macos-medium-m1
  image: macos-14-xcode-15
  before_script:
    - echo "started by ${GITLAB_USER_NAME}"

stages:
  - build

build-job:
  extends:
    - .macos_saas_runners
  stage: build
  script:
    - pip3 install codemagic-cli-tools
    - keychain initialize
    - keychain use-login
    - app-store-connect fetch-signing-files $(xcode-project detect-bundle-id) \
      --platform IOS \
      --type IOS_APP_STORE \
      --issuer-id=$APP_STORE_CONNECT_ISSUER_ID \
      --key-id=$APP_STORE_CONNECT_KEY_IDENTIFIER \
      --private-key=@file:${{ env.APP_STORE_CONNECT_PRIVATE_KEY_PATH }} \
      --certificate-key=@file:${{ env.APP_STORE_CERTIFICATE_KEY_PATH }} \
      --create
    - keychain add-certificates
    - xcode-project use-profiles
    - flutter packages pub get
    - find . -name "Podfile" -execdir pod install \;
    - flutter build ipa --export-options-plist=$HOME/export_options.plist
    - keychain use-login